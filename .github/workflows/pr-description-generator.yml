# .github/workflows/pr-description-generator.yml

name: "ğŸ¤– Reusable: PR Description Generator"

# å£°æ˜ä¸ºå¯å¤ç”¨å·¥ä½œæµ (workflow_call)
on:
  workflow_call:
    inputs:
      # PR ç¼–å·æ˜¯å¿…é¡»çš„ï¼Œç”¨äº gh cli å®šä½è¦ç¼–è¾‘çš„ PR
      pr_number:
        description: "The number of the Pull Request to update"
        required: true
        type: number
      # PR çš„æºåˆ†æ”¯åç§°
      source_branch:
        description: "The source branch of the PR (e.g., feature/my-cool-feature)"
        required: true
        type: string
      # PR çš„ç›®æ ‡åˆ†æ”¯åç§°
      target_branch:
        description: "The target branch of the PR (e.g., main or release)"
        required: true
        type: string
      # è§¦å‘ PR çš„åŸå§‹ä½œè€…
      pr_author:
        description: "The author of the Pull Request"
        required: true
        type: string
    secrets:
      # æ–°å¢ï¼šè®©è°ƒç”¨è€…å¯ä»¥ä¼ å…¥ç”¨äº PR æ›´æ–°çš„ Webhook URL
      PR_WEBHOOK_URL:
        description: 'The URL to send the PR update notification to'
        required: false
  # æ·»åŠ ä¸€ä¸ª push è§¦å‘å™¨ï¼Œä½†å‘Šè¯‰å®ƒå¿½ç•¥æ‰€æœ‰æ–‡ä»¶çš„å˜æ›´ã€‚
  # è¿™ä¼šé˜»æ­¢ GitHub Actions åœ¨ push æ—¶ä¸ºè¿™ä¸ªæ–‡ä»¶åˆ›å»ºâ€œæ— ä»»åŠ¡è¿è¡Œâ€çš„å¤±è´¥è®°å½•ã€‚
  push:
    paths-ignore:
      - '**'

jobs:
  generate-and-update:
    name: "ğŸ¤– Generate and Update PR Content"
    permissions:
      contents: read
      pull-requests: write
    runs-on: github-runner

    # è®¾ç½®ç¯å¢ƒå˜é‡
    env:
      WEBHOOK_URL: ${{ secrets.PR_WEBHOOK_URL }}

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç åº“ï¼Œè¿™æ˜¯ä¸ºäº†è·å– git å†å²
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤ 2: ç”Ÿæˆæ‰€æœ‰ PR å†…å®¹ (æ‘˜è¦å’Œè¯¦ç»†æ—¥å¿—)
      - name: "ğŸ“ Generate All PR Content"
        id: final_content
        run: |
          FINAL_BODY_FILE=$(mktemp)
          CHANGELOG_DETAILS_FILE=$(mktemp)
          COMMIT_RANGE="origin/${{ inputs.target_branch }}..origin/${{ inputs.source_branch }}"

          COMMIT_LOG_MARKDOWN=$(git log "$COMMIT_RANGE" --no-merges --pretty=format:"- [%h](${{ github.server_url }}/${{ github.repository }}/commit/%H) %s - by %an")

          # --- 2. ç»Ÿä¸€å¤„ç†æ‰€æœ‰ç±»åˆ« (æ‘˜è¦å’Œè¯¦ç»†æ—¥å¿—) ---
          summary_rows=()
          all_patterns=()

          # æ¸…ç©ºè¯¦ç»†æ—¥å¿—æ–‡ä»¶
          > "$CHANGELOG_DETAILS_FILE"

          # å®šä¹‰æ‰€æœ‰ç±»åˆ«ä¿¡æ¯çš„å•ä¸€æ•°æ®æºã€‚
          # æ ¼å¼: Pattern | Emoji | Display Name
          # ä»»ä½•åœ¨æ­¤å®šä¹‰çš„ç±»åˆ«ï¼Œåªè¦æœ‰ commitsï¼Œå°±ä¼šåŒæ—¶å‡ºç°åœ¨æ‘˜è¦å’Œè¯¦ç»†æ—¥å¿—ä¸­ã€‚
          while IFS='|' read -r pattern emoji display_name; do
            # æ¸…ç†å¯èƒ½å­˜åœ¨çš„å‰åç©ºæ ¼
            pattern=$(echo "$pattern" | xargs)
            emoji=$(echo "$emoji" | xargs)
            display_name=$(echo "$display_name" | xargs)
            
            all_patterns+=("$pattern")

            commits=$(echo "$COMMIT_LOG_MARKDOWN" | grep -i -E -- "$pattern" || true)

            if [[ -n "$commits" ]]; then
              # ç”Ÿæˆè¯¦ç»†æ—¥å¿—éƒ¨åˆ†
              echo -e "\n### $emoji $display_name\n" >> "$CHANGELOG_DETAILS_FILE"
              echo "$commits" >> "$CHANGELOG_DETAILS_FILE"

              # åŒæ—¶ç”Ÿæˆæ‘˜è¦éƒ¨åˆ†
              count=$(echo "$commits" | wc -l)
              summary_rows+=("| $emoji $display_name | $count |")
            fi
          done <<'CATEGORIES'
            feat(ure)?(\(.*\))?:      | âœ¨ | New Features
            fix(es)?(\(.*\))?:        | ğŸ› | Bug Fixes
            refactor(\(.*\))?:        | ğŸ”¨ | Refactoring
            perf(\(.*\))?:            | âš¡ï¸ | Performance Improvements
            ci(\(.*\))?:              | ğŸ¤– | CI/CD
            docs?(\(.*\))?:           | ğŸ“š | Documentation
            build(\(.*\))?:           | ğŸ“¦ | Build System
            test(\(.*\))?:            | âœ… | Tests
            \bchore(\(.*\))?:         | âš™ï¸ | Chores
          CATEGORIES

          # --- 3. å¤„ç† "Other" ç±»å‹çš„ Commitsï¼Œå¹¶å°†å…¶ä¹ŸåŠ å…¥æ‘˜è¦ ---
          ALL_PATTERNS_REGEX=$(IFS='|'; echo "${all_patterns[*]}")
          other_commits=$(echo "$COMMIT_LOG_MARKDOWN" | grep -i -v -E "$ALL_PATTERNS_REGEX" || true)
          if [[ -n "$other_commits" ]]; then
            # æ·»åŠ åˆ°è¯¦ç»†æ—¥å¿—
            echo -e "\n### ğŸ”§ Other Changes\n" >> "$CHANGELOG_DETAILS_FILE"
            echo "$other_commits" >> "$CHANGELOG_DETAILS_FILE"

            # ç»Ÿè®¡å…¶å®ƒçš„commit
            other_count=$(echo "$other_commits" | wc -l)
            summary_rows+=("| ğŸ”§ Other Changes | $other_count |")
          fi

          # --- 4. æ„å»ºæœ€ç»ˆçš„æ‘˜è¦è¡¨æ ¼ (ä¿®å¤ç‰ˆ) ---
          if [ ${#summary_rows[@]} -eq 0 ]; then
            SUMMARY_CONTENT="This PR includes general updates and improvements."
          else
            TABLE_HEADER="| Change Type | Count |\n| :--- | :--- |"
            # ä½¿ç”¨ printf å°†æ•°ç»„å…ƒç´ ç”¨æ¢è¡Œç¬¦è¿æ¥ï¼Œç”Ÿæˆè¡¨æ ¼ä¸»ä½“
            printf -v TABLE_BODY '%s\n' "${summary_rows[@]}"
            # å†æ¬¡ä½¿ç”¨ printf å¹¶å¸¦ä¸Š %b æ¥è§£é‡Š TABLE_HEADER ä¸­çš„ \n
            printf -v SUMMARY_CONTENT "%b" "${TABLE_HEADER}\n${TABLE_BODY}"
          fi

          # --- 5. ç»„åˆæœ€ç»ˆçš„ PR æè¿° ---
          CHANGELOG_DETAILS=$(cat "$CHANGELOG_DETAILS_FILE")
          cat <<EOF > "$FINAL_BODY_FILE"
          ### ğŸ“ PR Summary
          ${SUMMARY_CONTENT}

          **PR Author**: @${{ inputs.pr_author }}

          ---

          ### ğŸš€ Changes
          ${CHANGELOG_DETAILS}
          EOF

          echo "description_path=$FINAL_BODY_FILE" >> "$GITHUB_OUTPUT"

          # --- 6. ç”Ÿæˆ PR æ ‡é¢˜ ---
          TITLE="Merge ${{ inputs.source_branch }} into ${{ inputs.target_branch }} ($(date -u +'%Y-%m-%d %H:%M UTC'))"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

      # æ­¥éª¤ 3: æ›´æ–° Pull Request
      - name: "ğŸ“¤ Update Pull Request Title & Description"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          echo "Updating PR #${PR_NUMBER}..."
          gh pr edit "$PR_NUMBER" \
            --title "${{ steps.final_content.outputs.title }}" \
            --body-file "${{ steps.final_content.outputs.description_path }}"
          echo "PR updated successfully."

      # æ­¥éª¤ 4: åœ¨ PR æ›´æ–°æˆåŠŸåå‘é€é€šçŸ¥
      - name: 'ğŸ”” Send Webhook Notification'
        # æ¡ä»¶ï¼šæ£€æŸ¥ä¼ å…¥çš„ç¯å¢ƒå˜é‡ WEBHOOK_URL æ˜¯å¦ä¸ºç©º
        if: ${{ success() && env.WEBHOOK_URL != '' }}
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          PR_TITLE: ${{ steps.final_content.outputs.title }}
          PR_AUTHOR: ${{ inputs.pr_author }}
          REPO_NAME: ${{ github.repository }}
          PR_URL: "https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number }}"
        run: |
          # å‡†å¤‡ JSON payload
          JSON_PAYLOAD=$(printf '{ "repository": "%s", "pr_number": %s, "pr_title": "%s", "pr_author": "%s", "pr_url": "%s", "message": "ğŸ¤– PR #%s (''%s'') has been automatically updated." }'
          "$REPO_NAME" \
          "$PR_NUMBER" \
          "$PR_TITLE" \
          "$PR_AUTHOR" \
          "$PR_URL" \
          "$PR_NUMBER" \
          "$PR_TITLE")

          echo "Sending notification to webhook..."
          echo "Payload: $JSON_PAYLOAD"
          
          # ä½¿ç”¨ curl å‘é€ POST è¯·æ±‚
          curl -X POST -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD" \
               "$WEBHOOK_URL"
